<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéà Balloon Rescue Game üéà</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        body {
            font-family: 'Fredoka One', cursive;
            text-align: center;
            background: linear-gradient(to bottom, skyblue, white);
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 90vw;
            max-width: 360px;
            height: 70vh;
            max-height: 540px;
            background-color: rgba(255,255,255,0.9);
            margin: 20px auto;
            border: 2px solid black;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #game-container.paused {
            filter: grayscale(1);
            opacity: 0.6;
        }
        .balloon-group {
            position: absolute;
            text-align: center;
            transition: transform linear;
            cursor: pointer; /* easier to see it's clickable */
        }
        .sway-wrapper {
            display: inline-block;
            position: relative;
        }
        .hat {
            position: absolute;
            top: -26px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }
        .balloon {
            font-size: 30px;
            cursor: pointer;
            display: block;
            margin-bottom: -8px;
            transition: transform 0.2s;
        }
        .balloon:hover {
            transform: scale(1.2);
        }
        .balloon.selected-target {
            transform: scale(1.3);
            filter: drop-shadow(0 0 5px red);
        }
        .rope {
            font-size: 18px;
            display: block;
            transform: rotate(90deg);
            margin-bottom: -8px;
            pointer-events: none;
        }
        .attached {
            font-size: 30px;
            display: block;
            pointer-events: none;
        }
        .cloud {
            position: absolute;
            font-size: 40px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        #saved-animals {
            margin-top: 10px;
            font-size: 20px;
        }
        #next-level {
            display: none;
            margin-top: 20px;
            padding: 10px;
            font-size: 18px;
            background-color: #38a169;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #level-complete-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2em;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #level-complete-overlay.show {
            display: flex;
            animation: zoomIn 0.5s forwards;
            opacity: 1;
        }

        #level-complete-overlay.fade-out {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: scale(1.2); }
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <h1 class="text-3xl mt-4">üéà Balloon Rescue Game üéà</h1>
    <div id="stats" class="flex flex-wrap justify-center gap-4 mt-4 text-xl">
        <div>Level: <span id="level">1</span></div>
        <div>Score: <span id="score">0</span></div>
        <div>Animals Left: <span id="animals-left">10</span></div>
        <div>Missed: <span id="animals-missed">0</span></div>
    </div>
    <h3 class="mt-2">Animal Values: <span id="animal-values"></span></h3>
    <div id="combo" class="mt-2 text-red-600"></div>

    <div id="game-container"></div>

    <div id="controller-left" class="fixed bottom-4 left-4 grid grid-cols-3 gap-1 text-xl select-none">
        <div></div>
        <button onclick="navigateBalloon('up')" class="bg-gray-200 rounded">‚¨ÜÔ∏è</button>
        <div></div>
        <button onclick="navigateBalloon('left')" class="bg-gray-200 rounded">‚¨ÖÔ∏è</button>
        <div></div>
        <button onclick="navigateBalloon('right')" class="bg-gray-200 rounded">‚û°Ô∏è</button>
        <div></div>
        <button onclick="navigateBalloon('down')" class="bg-gray-200 rounded col-start-2">‚¨áÔ∏è</button>
    </div>

    <div id="controller-right" class="fixed bottom-4 right-4 flex flex-col items-center space-y-2 select-none">
        <button onclick="handleA()" class="w-12 h-12 bg-blue-500 text-white rounded-full">A</button>
        <button onclick="handleB()" class="w-12 h-12 bg-red-500 text-white rounded-full">B</button>
    </div>

    <button id="next-level" class="rounded px-4 py-2 bg-green-600 text-white mt-4" onclick="nextLevel()">Next Level</button>
    <button id="pause-btn" class="rounded px-4 py-2 bg-blue-600 text-white mt-4 ml-2" onclick="togglePause()">Pause</button>

    <div id="saved-animals" class="mt-4">
        <h3 class="font-bold">Saved Animals:</h3>
        <p id="saved-list"></p>
        <button id="album-btn" class="rounded px-2 py-1 bg-purple-600 text-white mt-2" onclick="openAlbum()">Animal Album</button>
    </div>

    <audio id="pop-sound" src="https://assets.mixkit.co/active_storage/sfx/2356/2356-preview.mp3"></audio>
    <div id="animal-album-modal" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-30">
        <div class="bg-white p-4 rounded w-72">
            <h3 class="text-xl mb-2 font-bold">Animal Album</h3>
            <div id="album-list" class="text-left"></div>
            <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded" onclick="closeAlbum()">Close</button>
        </div>
    </div>

    <div id="run-summary-modal" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-40">
        <div class="bg-white p-4 rounded w-72 text-center">
            <h3 class="text-xl mb-2 font-bold">Run Summary</h3>
            <p>Score: <span id="run-summary-score"></span></p>
            <p>Animals Rescued: <span id="run-summary-animals"></span></p>
            <p>Gold Earned: <span id="run-summary-gold"></span></p>
            <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded" onclick="closeRunSummary()">Close</button>
        </div>
    </div>

    <div id="rock-overlay" class="hidden fixed inset-0 bg-red-700 bg-opacity-75 flex items-center justify-center text-white text-2xl z-50">
        <div>Can't pop balloons!</div>
    </div>

    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center text-white z-50">
        <h2 class="text-3xl mb-4">Game Over</h2>
        <button class="px-4 py-2 bg-blue-600 rounded" onclick="restartGame()">Restart</button>
    </div>

    <div id="shop-modal" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-40">
        <div class="bg-white p-4 rounded w-72 text-center">
            <h3 class="text-xl mb-2 font-bold">Hat Shop</h3>
            <div id="hat-list" class="mb-4"></div>
            <button class="mt-2 px-4 py-2 bg-blue-600 text-white rounded" onclick="closeShop()">Close</button>
        </div>
    </div>

    <div id="main-menu" class="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center text-white z-50">
        <h2 class="text-3xl mb-2">Balloon Rescue Game</h2>
        <div>Gold: <span id="player-gold-display">0</span></div>
        <select id="hat-select" class="mt-2 text-black"></select>
        <button class="mt-2 px-4 py-2 bg-yellow-600 rounded" onclick="openShop()">Shop</button>
        <button class="mt-4 px-4 py-2 bg-green-600 rounded" onclick="startRun()">Start Run</button>
    </div>

    <script>
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        let score = parseInt(getCookie("score")) || 0;
        let level = parseInt(getCookie("level")) || 1;
        let animalsLeft;
        let balloonInterval;
        let cloudInterval;
        let countdownInterval;
        let balloonAnimations = [];
        let cloudAnimations = [];
        let savedAnimals = {};
          let animalTotals = JSON.parse(localStorage.getItem("animalTotals")) || {};
          let animalDescriptions = {"üêå":"Slow but steady", "üê¢":"Loves sunny days", "üêøÔ∏è":"Collects acorns", "ü¶é":"Expert climber", "üê•":"Cheerful chirper"};
        let usedPositions = [];
        let isPaused = false;
        let remainingCountdown = null;
        let doublePoints = false;
        let shield = false;
        let comboCount = 0;
        let comboTimer;
        let comboMultiplier = 1;
        let selectedBalloonGroup = null;

        const LEVEL_CAP = 5;
        let runScore = 0;
        let runGold = 0;
        let animalsRescuedThisRun = 0;
        let rocksHitThisRun = 0;
        let animalsMissed = 0;
        const MAX_MISSED = 5;
        let canPop = true;
        let playerGold = parseInt(localStorage.getItem("playerGold")) || 0;
        const hatEmojis = { cap: "üß¢", crown: "üëë", wizard: "üé©" };
        let hats = [
            { id: "cap", name: "Cap", price: 50, unlocked: false },
            { id: "crown", name: "Crown", price: 100, unlocked: false },
            { id: "wizard", name: "Wizard Hat", price: 150, unlocked: false }
        ];
        const unlocked = JSON.parse(localStorage.getItem("unlockedHats")) || ["none"];
        hats.forEach(h => { if (unlocked.includes(h.id)) h.unlocked = true; });
        let selectedHat = localStorage.getItem("selectedHat") || "none";

        let animalData = {
            "üêå": { speed: 2.7, points: 20, rarity: "rare" },
            "üê¢": { speed: 4.4, points: 5, rarity: "common" },
            "üêøÔ∏è": { speed: 3.8, points: 10, rarity: "common" },
            "ü¶é": { speed: 3.4, points: 15, rarity: "uncommon" },
            "üê•": { speed: 3.6, points: 12, rarity: "uncommon" },
            "ü¶Ñ": { speed: 2.5, points: 50, rarity: "legendary" },
            "ü™®": { speed: 3.5, points: -10, rarity: "common" }
        };

        let balloonColors = ["üü†", "üü°", "üü¢", "üü£", "üü§", "üî¥", "üîµ", "‚ö™", "‚ö´"];
        let animals = Object.keys(animalData);
        let powerUps = ["‚ú®", "üßä", "üõ°Ô∏è"];
        let hazards = ["üí£"];

        const rarityWeights = { common: 5, uncommon: 3, rare: 1, legendary: 0.2 };

        function getRandomAnimal() {
            const available = animals.filter(a => a !== "ü™®" && !(animalData[a].rarity === "legendary" && level < 10));
            let total = 0;
            available.forEach(a => { total += rarityWeights[animalData[a].rarity] || 1; });
            let r = Math.random() * total;
            for (let a of available) {
                r -= rarityWeights[animalData[a].rarity] || 1;
                if (r <= 0) return a;
            }
            return available[0];
        }

        function startGame() {
            if (level === 1) {
                runScore = 0;
                runGold = 0;
                animalsRescuedThisRun = 0;
                rocksHitThisRun = 0;
                animalsMissed = 0;
                const missEl = document.getElementById("animals-missed");
                if (missEl) missEl.innerText = animalsMissed;
            }
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            clearInterval(countdownInterval);
            document.getElementById("main-menu").classList.add("hidden");
            document.getElementById("run-summary-modal").classList.add("hidden");
            document.getElementById("game-container").style.pointerEvents = 'auto';
            canPop = true;
            balloonAnimations.forEach(anim => anim.pause());
            balloonAnimations = [];
            cloudAnimations.forEach(anim => anim.pause());
            cloudAnimations = [];
            const container = document.getElementById("game-container");
            container.innerHTML = `
                <div id="level-complete-overlay">
                    <div>Level Complete!</div>
                    <div id="countdown"></div>
                </div>`;
            const backgrounds = [
                'linear-gradient(to bottom, skyblue, white)',
                'linear-gradient(to bottom, #FFDEE9, #B5FFFC)',
                'linear-gradient(to bottom, #FDB99B, #CF8BF3)'
            ];
            document.body.style.background = backgrounds[Math.floor((level - 1) / 10) % backgrounds.length];
            animalsLeft = Math.max(10 + (level - 1), 0);
            savedAnimals = {};
            selectedBalloonGroup = null;
            usedPositions = [];
            document.getElementById("rock-overlay").classList.add("hidden");
            document.getElementById("game-over-modal").classList.add("hidden");
            setCookie("level", level, 7);
            setCookie("score", score, 7);
            document.getElementById("score").innerText = score;
            document.getElementById("level").innerText = level;
            document.getElementById("animals-left").innerText = animalsLeft;
            updateSavedAnimalsDisplay();
            updateAlbum();
            document.getElementById("next-level").style.display = "none";
            const overlay = document.getElementById("level-complete-overlay");
            overlay.style.display = "none";
            overlay.classList.remove("show", "fade-out");

            updateAnimalValues();
            spawnClouds();
            spawnBalloons();
        }

        function updateAnimalValues() {
            let valuesText = animals.map(animal => `${animal}: ${animalData[animal].points} pts`).join(" | ");
            document.getElementById("animal-values").innerText = valuesText;
        }

        function spawnClouds() {
            // Create initial clouds
            for (let i = 0; i < 3; i++) {
                createCloud();
            }
            
            // Set up cloud spawning interval
            cloudInterval = setInterval(() => {
                if (isPaused) return;
                if (document.querySelectorAll('.cloud').length < 5) {
                    createCloud();
                }
            }, 8000);
        }
        
        function createCloud() {
            let cloud = document.createElement("div");
            cloud.classList.add("cloud");
            cloud.innerHTML = "‚òÅÔ∏è";
            
            // Random position
            cloud.style.top = Math.floor(Math.random() * 200) + "px";
            cloud.style.left = "-50px";
            
            document.getElementById("game-container").appendChild(cloud);
            
            // Animate cloud movement
            let speed = Math.random() * 25 + 15; // 15-40 seconds to cross
            cloud.style.transform = 'translateX(0)';

            setTimeout(() => {
                if (isPaused) {
                    cloud.remove();
                    return;
                }
                const anim = anime({
                    targets: cloud,
                    translateX: 400,
                    duration: speed * 1000,
                    easing: 'linear',
                    complete: () => {
                        cloud.remove();
                        const idx = cloudAnimations.indexOf(anim);
                        if (idx !== -1) cloudAnimations.splice(idx, 1);
                    }
                });
                cloudAnimations.push(anim);
            }, 100);
        }

        function spawnBalloons() {
            const interval = Math.max(2000 - (level - 1) * 100, 800);
            balloonInterval = setInterval(() => {
                if (isPaused) return;
                let numBalloons = Math.floor(Math.random() * 3) + 1;
                usedPositions = [];

                for (let i = 0; i < numBalloons; i++) {
                    let balloonGroup = document.createElement("div");
                    balloonGroup.classList.add("balloon-group");

                    let swayWrapper = document.createElement("div");
                    swayWrapper.classList.add("sway-wrapper");

                    let balloon = document.createElement("div");
                    balloon.classList.add("balloon");
                    let selectedBalloon = balloonColors[Math.floor(Math.random() * balloonColors.length)];
                    balloon.innerHTML = selectedBalloon;

                    let rope = document.createElement("div");
                    rope.classList.add("rope");
                    rope.innerHTML = "„Ä∞Ô∏è";

                    let attached = document.createElement("div");
                    attached.classList.add("attached");
                    let rand = Math.random();
                    let selectedAnimal;
                    const rockChance = Math.min(0.1 + level * 0.02, 0.5);
                    const powerUpChance = 0.05;
                    const hazardChance = 0.05;
                    if (rand < powerUpChance) {
                        selectedAnimal = powerUps[Math.floor(Math.random() * powerUps.length)];
                    } else if (rand < powerUpChance + hazardChance) {
                        selectedAnimal = hazards[Math.floor(Math.random() * hazards.length)];
                    } else if (Math.random() < rockChance) {
                        selectedAnimal = "ü™®";
                    } else {
                        selectedAnimal = getRandomAnimal();
                    }
                    attached.innerHTML = selectedAnimal;
                    balloonGroup.dataset.attached = selectedAnimal;

                    if (selectedHat !== "none") {
                        const hatEl = document.createElement("div");
                        hatEl.classList.add("hat");
                        hatEl.innerHTML = hatEmojis[selectedHat];
                        swayWrapper.appendChild(hatEl);
                    }
                    swayWrapper.appendChild(balloon);
                    swayWrapper.appendChild(rope);
                    swayWrapper.appendChild(attached);
                    balloonGroup.appendChild(swayWrapper);

                    let balloonSpeed = animalData[selectedAnimal].speed / (1 + (level - 1) * 0.05);

                    let leftPosition;
                    do {
                        leftPosition = Math.floor(Math.random() * 250);
                    } while (usedPositions.some(pos => Math.abs(pos - leftPosition) < 50));

                    usedPositions.push(leftPosition);
                    balloonGroup.style.left = leftPosition + "px";
                    balloonGroup.style.bottom = "-50px";
                    balloonGroup.style.opacity = "0";

                    // Make entire group clickable for easier tapping
                    balloonGroup.onclick = () => popBalloon(balloonGroup, selectedAnimal);

                    document.getElementById("game-container").appendChild(balloonGroup);

                    setTimeout(() => {
                        if (isPaused) {
                            balloonGroup.remove();
                            return;
                        }
                        const h = document.getElementById("game-container").clientHeight;
                        anime({
                            targets: balloonGroup,
                            opacity: [0, 1],
                            duration: 800,
                            easing: 'linear'
                        });
                        const swayAnim = anime({
                            targets: swayWrapper,
                            translateX: [`-${15 + level * 2}px`, `${15 + level * 2}px`],
                            duration: 3000,
                            direction: 'alternate',
                            loop: true,
                            easing: 'easeInOutSine',
                            delay: Math.random() * 1000
                        });
                        const anim = anime({
                            targets: balloonGroup,
                            translateY: -h,
                            duration: balloonSpeed * 1000,
                            easing: 'easeInOutSine',
                            complete: () => {
                                swayAnim.pause();
                                if (balloonGroup.popped) return;
                                const fadeAnim = anime({
                                    targets: balloonGroup,
                                    opacity: 0,
                                    duration: 500,
                                    easing: 'linear',
                                    complete: () => {
                                        balloonGroup.remove();
                                        handleBalloonMiss(selectedAnimal);
                                        const idx = balloonAnimations.indexOf(anim);
                                        if (idx !== -1) balloonAnimations.splice(idx, 1);
                                        const idx2 = balloonAnimations.indexOf(swayAnim);
                                        if (idx2 !== -1) balloonAnimations.splice(idx2, 1);
                                        const idx3 = balloonAnimations.indexOf(fadeAnim);
                                        if (idx3 !== -1) balloonAnimations.splice(idx3, 1);
                                    }
                                });
                                balloonAnimations.push(fadeAnim);
                            }
                        });
                        balloonGroup._anim = anim;
                        balloonGroup._sway = swayAnim;
                        balloonAnimations.push(anim, swayAnim);
                    }, 100);
                }
            }, interval);
        }

        function popBalloon(balloonGroup, attachedItem) {
            if (isPaused || !canPop) return;
            balloonGroup.popped = true;
            if (balloonGroup._anim) balloonGroup._anim.pause();
            if (balloonGroup._sway) balloonGroup._sway.pause();
            anime.remove(balloonGroup);
            anime.remove(balloonGroup.querySelector('.sway-wrapper'));
            let balloon = balloonGroup.querySelector(".balloon");
            // Disable further clicks once popped
            balloonGroup.onclick = null;

            anime({
                targets: balloon,
                scale: [1, 2, 0],
                duration: 200,
                easing: 'easeInOutQuad'
            });
            setTimeout(() => {
                balloon.innerHTML = "üí•";
                const pop = document.getElementById('pop-sound');
                if (pop) { pop.currentTime = 0; pop.play(); }
            }, 120);

            let delta = 0;

            if (attachedItem === "ü™®") {
                if (shield) {
                    shield = false;
                } else {
                    delta = -10;
                    score += delta;
                    rocksHitThisRun++;
                    handleRockPenalty();
                }
                comboCount = 0;
                comboMultiplier = 1;
                document.getElementById('combo').innerText = '';
            } else if (powerUps.includes(attachedItem)) {
                applyPowerUp(attachedItem);
            } else if (hazards.includes(attachedItem)) {
                delta = -15;
                score += delta;
                comboCount = 0;
                comboMultiplier = 1;
                document.getElementById('combo').innerText = '';
            } else {
                let pts = animalData[attachedItem].points;
                if (doublePoints) pts *= 2;
                pts = Math.floor(pts * comboMultiplier);
                delta = pts;
                score += delta;
                savedAnimals[attachedItem] = (savedAnimals[attachedItem] || 0) + 1;
                  animalTotals[attachedItem] = (animalTotals[attachedItem] || 0) + 1;
                  localStorage.setItem("animalTotals", JSON.stringify(animalTotals));
                  updateAlbum();
                animalsLeft = Math.max(animalsLeft - 1, 0);
                registerCombo();
                animalsRescuedThisRun++;
                runGold += 1;
            }

            runScore += delta;

            if (rocksHitThisRun >= 3) {
                endRun();
                return;
            }

            const scoreEl = document.getElementById("score");
            const animalsLeftEl = document.getElementById("animals-left");
            scoreEl.innerText = score;
            animalsLeftEl.innerText = animalsLeft;
            anime({ targets: [scoreEl, animalsLeftEl], scale: [1.3, 1], duration: 300, easing: 'easeOutElastic(1, .8)' });
            updateSavedAnimalsDisplay();

                        const h = document.getElementById("game-container").clientHeight;
            balloonGroup.style.transform = "none";
            setTimeout(() => {
                balloonGroup.remove();
                if (selectedBalloonGroup === balloonGroup) {
                    deselectBalloon();
                }
            }, 200);

            if (animalsLeft === 0) {
                endLevel();
            }
        }

        function updateSavedAnimalsDisplay() {
            let savedList = document.getElementById("saved-list");
            savedList.innerHTML = "";
            
            for (let animal in savedAnimals) {
                if (savedAnimals[animal] > 0) {
                    savedList.innerHTML += `${animal} x${savedAnimals[animal]} `;
                }
            }
            
            if (savedList.innerHTML === "") {
                savedList.innerHTML = "None yet";
            }
        }

        function applyPowerUp(type) {
            if (type === "‚ú®") {
                doublePoints = true;
                setTimeout(() => doublePoints = false, 10000);
            } else if (type === "üßä") {
                pauseGame();
                setTimeout(() => resumeGame(), 3000);
            } else if (type === "üõ°Ô∏è") {
                shield = true;
                setTimeout(() => shield = false, 15000);
            }
        }

        function registerCombo() {
            comboCount++;
            comboMultiplier = 1 + Math.floor(comboCount / 3) * 0.5;
            showComboMessage();
            clearTimeout(comboTimer);
            comboTimer = setTimeout(() => {
                comboCount = 0;
                comboMultiplier = 1;
                document.getElementById("combo").innerText = "";
            }, 1000);
        }

        function showComboMessage() {
            if (comboCount < 3) return;
            const msg = comboCount >= 6 ? "Amazing!" : "Great!";
            const el = document.getElementById("combo");
            el.innerText = msg + ` x${comboMultiplier.toFixed(1)}`;
        }

        const rarityColors = { common: '#6B7280', uncommon: '#16A34A', rare: '#2563EB', legendary: '#A21CAF' };
        const rarityStars = { common: '‚≠ê', uncommon: '‚≠ê‚≠ê', rare: '‚≠ê‚≠ê‚≠ê', legendary: 'üåü' };

        function updateAlbum() {
            const albumList = document.getElementById("album-list");
            if (!albumList) return;
            albumList.innerHTML = "";
            for (let animal in animalTotals) {
                const rarity = animalData[animal]?.rarity || 'common';
                const color = rarityColors[rarity] || '#6B7280';
                const stars = rarityStars[rarity] || '';
                const desc = animalDescriptions[animal] || '';
                albumList.innerHTML += `<div class="flex justify-between border-b py-1"><span>${animal} x${animalTotals[animal]} - ${desc}</span><span style="color:${color}">${stars}</span></div>`;
            }
            if (albumList.innerHTML === "") albumList.innerHTML = "No animals saved yet.";
        }

       function openAlbum() {
           updateAlbum();
           document.getElementById("animal-album-modal").classList.remove("hidden");
       }

       function closeAlbum() {
           document.getElementById("animal-album-modal").classList.add("hidden");
       }

        function handleRockPenalty() {
            canPop = false;
            const overlay = document.getElementById("rock-overlay");
            overlay.classList.remove("hidden");
            document.getElementById("game-container").style.pointerEvents = 'none';
            setTimeout(() => {
                overlay.classList.add("hidden");
                document.getElementById("game-container").style.pointerEvents = 'auto';
                canPop = true;
            }, 2000);
        }

        function handleBalloonMiss(item) {
            if (animalData[item] && item !== 'ü™®') {
                animalsMissed++;
                const missEl = document.getElementById("animals-missed");
                if (missEl) {
                    missEl.innerText = animalsMissed;
                    anime({ targets: missEl, scale: [1.3, 1], duration: 300, easing: 'easeOutElastic(1, .8)' });
                }
                if (animalsMissed >= MAX_MISSED) {
                    gameOver();
                }
            }
        }

        function gameOver() {
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            balloonAnimations.forEach(a => a.pause());
            cloudAnimations.forEach(a => a.pause());
            document.getElementById("game-over-modal").classList.remove("hidden");
        }

        function restartGame() {
            document.getElementById("game-over-modal").classList.add("hidden");
            score = 0;
            level = 1;
            startGame();
        }

        function selectBalloon(bg) {
            if (selectedBalloonGroup) {
                const b = selectedBalloonGroup.querySelector('.balloon');
                if (b) b.classList.remove('selected-target');
            }
            selectedBalloonGroup = bg;
            if (selectedBalloonGroup) {
                const b = selectedBalloonGroup.querySelector('.balloon');
                if (b) b.classList.add('selected-target');
            }
        }

        function deselectBalloon() {
            selectBalloon(null);
        }

        function selectRandomBalloon() {
            const groups = document.querySelectorAll('.balloon-group');
            if (groups.length === 0) return;
            const rand = groups[Math.floor(Math.random() * groups.length)];
            selectBalloon(rand);
        }

        function handleA() {
            if (!canPop) return;
            if (!selectedBalloonGroup) {
                selectRandomBalloon();
            } else {
                popBalloon(selectedBalloonGroup, selectedBalloonGroup.dataset.attached);
                deselectBalloon();
            }
        }

        function handleB() {
            if (selectedBalloonGroup) {
                deselectBalloon();
            }
        }

        function navigateBalloon(dir) {
            if (!selectedBalloonGroup) return;
            const groups = document.querySelectorAll('.balloon-group');
            const rectSel = selectedBalloonGroup.getBoundingClientRect();
            const cx = rectSel.left + rectSel.width / 2;
            const cy = rectSel.top + rectSel.height / 2;
            let best = null;
            let bestDist = Infinity;
            groups.forEach(bg => {
                if (bg === selectedBalloonGroup) return;
                const rect = bg.getBoundingClientRect();
                const bx = rect.left + rect.width / 2;
                const by = rect.top + rect.height / 2;
                let dist;
                if (dir === 'left' && bx < cx) dist = cx - bx;
                else if (dir === 'right' && bx > cx) dist = bx - cx;
                else if (dir === 'up' && by < cy) dist = cy - by;
                else if (dir === 'down' && by > cy) dist = by - cy;
                else return;
                if (dist < bestDist) { bestDist = dist; best = bg; }
            });
            if (best) selectBalloon(best);
        }


       function endLevel() {
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            document.getElementById("next-level").style.display = "none";
            setCookie("level", level, 7);
            setCookie("score", score, 7);
            const overlay = document.getElementById("level-complete-overlay");
            const countdownEl = document.getElementById("countdown");
            overlay.style.display = "flex";
            anime({
                targets: overlay,
                opacity: [0, 1],
                scale: [0.8, 1],
                duration: 500,
                easing: 'easeOutExpo'
            });
            let count = 3;
            countdownEl.innerText = count;
            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.innerText = count;
                    anime({ targets: countdownEl, scale: [1.4, 1], duration: 300, easing: 'easeOutBack' });
                } else {
                    clearInterval(countdownInterval);
                    anime({
                        targets: overlay,
                        opacity: [1, 0],
                        scale: [1, 1.2],
                        duration: 500,
                        easing: 'easeInExpo',
                        complete: () => {
                            overlay.style.display = 'none';
                            nextLevel();
                        }
                    });
                }
            }, 1000);
        }

        function nextLevel() {
            level++;
            if (level > LEVEL_CAP) {
                endRun();
                return;
            }
            setCookie("level", level, 7);
            setCookie("score", score, 7);
            startGame();
        }

        function togglePause() {
            if (isPaused) {
                resumeGame();
            } else {
                pauseGame();
            }
        }

        function pauseGame() {
            if (isPaused) return;
            isPaused = true;
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            clearInterval(countdownInterval);
            const countdownEl = document.getElementById("countdown");
            if (countdownEl && countdownEl.innerText) {
                remainingCountdown = parseInt(countdownEl.innerText);
            }
            balloonAnimations.forEach(anim => anim.pause());
            cloudAnimations.forEach(anim => anim.pause());
            document.querySelectorAll('.balloon').forEach(b => b.style.pointerEvents = 'none');
            document.querySelectorAll('.balloon-group').forEach(bg => bg.style.pointerEvents = 'none');
            const container = document.getElementById("game-container");
            if (container) container.classList.add("paused");
            const btn = document.getElementById("pause-btn");
            if (btn) btn.innerText = "Resume";
        }

        function resumeGame() {
            if (!isPaused) return;
            isPaused = false;
            balloonAnimations.forEach(anim => anim.play());
            cloudAnimations.forEach(anim => anim.play());
            document.querySelectorAll('.balloon').forEach(b => b.style.pointerEvents = 'auto');
            document.querySelectorAll('.balloon-group').forEach(bg => bg.style.pointerEvents = 'auto');
            const container = document.getElementById("game-container");
            if (container) container.classList.remove("paused");
            spawnClouds();
            spawnBalloons();
            if (remainingCountdown !== null) {
                let count = remainingCountdown;
                const countdownEl = document.getElementById("countdown");
                if (countdownEl) {
                    countdownEl.innerText = count;
                    countdownInterval = setInterval(() => {
                        count--;
                        if (count > 0) {
                            countdownEl.innerText = count;
                            anime({ targets: countdownEl, scale: [1.4, 1], duration: 300, easing: 'easeOutBack' });
                        } else {
                            clearInterval(countdownInterval);
                            const overlay = document.getElementById("level-complete-overlay");
                            if (overlay) {
                                anime({
                                    targets: overlay,
                                    opacity: [1, 0],
                                    scale: [1, 1.2],
                                    duration: 500,
                                    easing: 'easeInExpo',
                                    complete: () => {
                                        overlay.style.display = 'none';
                                        nextLevel();
                                    }
                                });
                            }
                        }
                    }, 1000);
                }
                remainingCountdown = null;
            }
            const btn = document.getElementById("pause-btn");
            if (btn) btn.innerText = "Pause";
        }

        function updatePlayerGoldDisplay() {
            const el = document.getElementById("player-gold-display");
            if (el) el.innerText = playerGold;
        }

        function startRun() {
            level = 1;
            startGame();
        }

        function endRun() {
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            playerGold += runGold;
            localStorage.setItem("playerGold", playerGold);
            updatePlayerGoldDisplay();
            document.getElementById("run-summary-score").innerText = runScore;
            document.getElementById("run-summary-animals").innerText = animalsRescuedThisRun;
            document.getElementById("run-summary-gold").innerText = runGold;
            document.getElementById("run-summary-modal").classList.remove("hidden");
        }

        function closeRunSummary() {
            document.getElementById("run-summary-modal").classList.add("hidden");
            level = 1;
            setCookie("level", level, 7);
            document.getElementById("main-menu").classList.remove("hidden");
            updatePlayerGoldDisplay();
            updateHatDropdown();
        }

        function openShop() {
            updateShop();
            document.getElementById("shop-modal").classList.remove("hidden");
        }

        function closeShop() {
            document.getElementById("shop-modal").classList.add("hidden");
        }

        function updateShop() {
            const list = document.getElementById("hat-list");
            list.innerHTML = "";
            hats.forEach(h => {
                if (h.id === "none") return;
                const row = document.createElement("div");
                row.className = "flex justify-between items-center mb-2";
                const name = document.createElement("span");
                name.innerText = `${hatEmojis[h.id]} ${h.name} - ${h.price}g`;
                const btn = document.createElement("button");
                btn.className = "px-2 py-1 bg-green-600 text-white rounded";
                btn.innerText = h.unlocked ? "Owned" : "Buy";
                btn.disabled = h.unlocked || playerGold < h.price;
                btn.onclick = () => purchaseHat(h.id);
                row.appendChild(name);
                row.appendChild(btn);
                list.appendChild(row);
            });
            updatePlayerGoldDisplay();
        }

        function purchaseHat(id) {
            const hat = hats.find(h => h.id === id);
            if (!hat || hat.unlocked || playerGold < hat.price) return;
            playerGold -= hat.price;
            hat.unlocked = true;
            localStorage.setItem("playerGold", playerGold);
            const unlocked = hats.filter(h => h.unlocked).map(h => h.id);
            localStorage.setItem("unlockedHats", JSON.stringify(unlocked));
            updateShop();
            updateHatDropdown();
        }

        function updateHatDropdown() {
            const sel = document.getElementById("hat-select");
            if (!sel) return;
            sel.innerHTML = "";
            const noneOpt = document.createElement("option");
            noneOpt.value = "none";
            noneOpt.text = "No Hat";
            if (selectedHat === "none") noneOpt.selected = true;
            sel.appendChild(noneOpt);
            hats.filter(h => h.unlocked).forEach(h => {
                const opt = document.createElement("option");
                opt.value = h.id;
                opt.text = `${hatEmojis[h.id]} ${h.name}`;
                if (h.id === selectedHat) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        updatePlayerGoldDisplay();
        updateHatDropdown();
        const hatSel = document.getElementById("hat-select");
        if (hatSel) {
            hatSel.addEventListener('change', e => {
                selectedHat = e.target.value;
                localStorage.setItem("selectedHat", selectedHat);
            });
        }
    </script>

</body>
</html>