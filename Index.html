<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎈 Balloon Rescue Game 🎈</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        body {
            font-family: 'Fredoka One', cursive;
            text-align: center;
            background: linear-gradient(to bottom, skyblue, white);
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 90vw;
            max-width: 360px;
            height: 70vh;
            max-height: 540px;
            background-color: rgba(255,255,255,0.9);
            margin: 20px auto;
            border: 2px solid black;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #game-container.paused {
            filter: grayscale(1);
            opacity: 0.6;
        }
        .balloon-group {
            position: absolute;
            text-align: center;
            transition: transform linear;
            cursor: pointer; /* easier to see it's clickable */
        }
        .sway-wrapper {
            display: inline-block;
        }
        .balloon {
            font-size: 30px;
            cursor: pointer;
            display: block;
            margin-bottom: -8px;
            transition: transform 0.2s;
        }
        .balloon:hover {
            transform: scale(1.2);
        }
        .rope {
            font-size: 18px;
            display: block;
            transform: rotate(90deg);
            margin-bottom: -8px;
            pointer-events: none;
        }
        .attached {
            font-size: 30px;
            display: block;
            pointer-events: none;
        }
        .cloud {
            position: absolute;
            font-size: 40px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        #saved-animals {
            margin-top: 10px;
            font-size: 20px;
        }
        #next-level {
            display: none;
            margin-top: 20px;
            padding: 10px;
            font-size: 18px;
            background-color: #38a169;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #level-complete-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2em;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #level-complete-overlay.show {
            display: flex;
            animation: zoomIn 0.5s forwards;
            opacity: 1;
        }

        #level-complete-overlay.fade-out {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: scale(1.2); }
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <h1 class="text-3xl mt-4">🎈 Balloon Rescue Game 🎈</h1>
    <div id="stats" class="flex flex-wrap justify-center gap-4 mt-4 text-xl">
        <div>Level: <span id="level">1</span></div>
        <div>Score: <span id="score">0</span></div>
        <div>Animals Left: <span id="animals-left">10</span></div>
    </div>
    <h3 class="mt-2">Animal Values: <span id="animal-values"></span></h3>
    <div id="combo" class="mt-2 text-red-600"></div>

    <div id="game-container"></div>

    <button id="next-level" class="rounded px-4 py-2 bg-green-600 text-white mt-4" onclick="nextLevel()">Next Level</button>
    <button id="pause-btn" class="rounded px-4 py-2 bg-blue-600 text-white mt-4 ml-2" onclick="togglePause()">Pause</button>

    <div id="saved-animals" class="mt-4">
        <h3 class="font-bold">Saved Animals:</h3>
        <p id="saved-list"></p>
    </div>

    <div id="achievements" class="mt-4">
        <h3 class="font-bold">Achievements:</h3>
        <p id="achievements-list"></p>
        <h4 class="font-bold mt-2">Today's Challenge:</h4>
        <p id="daily-challenge"></p>
    </div>

    <audio id="pop-sound" src="https://assets.mixkit.co/active_storage/sfx/2356/2356-preview.mp3"></audio>

    <script>
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + value + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        let score = parseInt(getCookie("score")) || 0;
        let level = parseInt(getCookie("level")) || 1;
        let animalsLeft;
        let balloonInterval;
        let cloudInterval;
        let countdownInterval;
        let balloonAnimations = [];
        let cloudAnimations = [];
        let savedAnimals = {};
        let usedPositions = [];
        let isPaused = false;
        let remainingCountdown = null;
        let doublePoints = false;
        let shield = false;
        let comboCount = 0;
        let comboTimer;
        let comboMultiplier = 1;

        let popCount = parseInt(localStorage.getItem("popCount")) || 0;
        let achievements = JSON.parse(localStorage.getItem("achievements")) || {
            firstPop: false,
            pop50: false,
            level5: false,
            combo3: false
        };
        let dailyChallenge = JSON.parse(localStorage.getItem("dailyChallenge")) || null;
        const today = new Date().toDateString();
        if (!dailyChallenge || dailyChallenge.date !== today) {
            dailyChallenge = {
                date: today,
                description: "Save 5 🐢 today",
                animal: "🐢",
                goal: 5,
                progress: 0,
                done: false
            };
            localStorage.setItem("dailyChallenge", JSON.stringify(dailyChallenge));
        }

        let animalData = {
            "🐌": { speed: 2.7, points: 20 },
            "🐢": { speed: 4.4, points: 5 },
            "🐿️": { speed: 3.8, points: 10 },
            "🦎": { speed: 3.4, points: 15 },
            "🐥": { speed: 3.6, points: 12 },
            "🪨": { speed: 3.5, points: -10 }
        };

        let balloonColors = ["🟠", "🟡", "🟢", "🟣", "🟤", "🔴", "🔵", "⚪", "⚫"];
        let animals = Object.keys(animalData);
        let powerUps = ["✨", "🧊", "🛡️"];
        let hazards = ["💣"];

        function startGame() {
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            clearInterval(countdownInterval);
            balloonAnimations.forEach(anim => anim.pause());
            balloonAnimations = [];
            cloudAnimations.forEach(anim => anim.pause());
            cloudAnimations = [];
            const container = document.getElementById("game-container");
            container.innerHTML = `
                <div id="level-complete-overlay">
                    <div>Level Complete!</div>
                    <div id="countdown"></div>
                </div>`;
            const backgrounds = [
                'linear-gradient(to bottom, skyblue, white)',
                'linear-gradient(to bottom, #FFDEE9, #B5FFFC)',
                'linear-gradient(to bottom, #FDB99B, #CF8BF3)'
            ];
            document.body.style.background = backgrounds[Math.floor((level - 1) / 10) % backgrounds.length];
            animalsLeft = Math.max(10 + (level - 1), 0);
            savedAnimals = {};
            usedPositions = [];
            setCookie("level", level, 7);
            setCookie("score", score, 7);
            document.getElementById("score").innerText = score;
            document.getElementById("level").innerText = level;
            document.getElementById("animals-left").innerText = animalsLeft;
            updateSavedAnimalsDisplay();
            updateAchievementsDisplay();
            checkAchievements();
            document.getElementById("next-level").style.display = "none";
            const overlay = document.getElementById("level-complete-overlay");
            overlay.style.display = "none";
            overlay.classList.remove("show", "fade-out");

            updateAnimalValues();
            spawnClouds();
            spawnBalloons();
        }

        function updateAnimalValues() {
            let valuesText = animals.map(animal => `${animal}: ${animalData[animal].points} pts`).join(" | ");
            document.getElementById("animal-values").innerText = valuesText;
        }

        function spawnClouds() {
            // Create initial clouds
            for (let i = 0; i < 3; i++) {
                createCloud();
            }
            
            // Set up cloud spawning interval
            cloudInterval = setInterval(() => {
                if (isPaused) return;
                if (document.querySelectorAll('.cloud').length < 5) {
                    createCloud();
                }
            }, 8000);
        }
        
        function createCloud() {
            let cloud = document.createElement("div");
            cloud.classList.add("cloud");
            cloud.innerHTML = "☁️";
            
            // Random position
            cloud.style.top = Math.floor(Math.random() * 200) + "px";
            cloud.style.left = "-50px";
            
            document.getElementById("game-container").appendChild(cloud);
            
            // Animate cloud movement
            let speed = Math.random() * 25 + 15; // 15-40 seconds to cross
            cloud.style.transform = 'translateX(0)';

            setTimeout(() => {
                if (isPaused) {
                    cloud.remove();
                    return;
                }
                const anim = anime({
                    targets: cloud,
                    translateX: 400,
                    duration: speed * 1000,
                    easing: 'linear',
                    complete: () => {
                        cloud.remove();
                        const idx = cloudAnimations.indexOf(anim);
                        if (idx !== -1) cloudAnimations.splice(idx, 1);
                    }
                });
                cloudAnimations.push(anim);
            }, 100);
        }

        function spawnBalloons() {
            const interval = Math.max(2000 - (level - 1) * 100, 800);
            balloonInterval = setInterval(() => {
                if (isPaused) return;
                let numBalloons = Math.floor(Math.random() * 3) + 1;
                usedPositions = [];

                for (let i = 0; i < numBalloons; i++) {
                    let balloonGroup = document.createElement("div");
                    balloonGroup.classList.add("balloon-group");

                    let swayWrapper = document.createElement("div");
                    swayWrapper.classList.add("sway-wrapper");

                    let balloon = document.createElement("div");
                    balloon.classList.add("balloon");
                    let selectedBalloon = balloonColors[Math.floor(Math.random() * balloonColors.length)];
                    balloon.innerHTML = selectedBalloon;

                    let rope = document.createElement("div");
                    rope.classList.add("rope");
                    rope.innerHTML = "〰️";

                    let attached = document.createElement("div");
                    attached.classList.add("attached");
                    let rand = Math.random();
                    let selectedAnimal;
                    const rockChance = Math.min(0.1 + level * 0.02, 0.5);
                    const powerUpChance = 0.05;
                    const hazardChance = 0.05;
                    if (rand < powerUpChance) {
                        selectedAnimal = powerUps[Math.floor(Math.random() * powerUps.length)];
                    } else if (rand < powerUpChance + hazardChance) {
                        selectedAnimal = hazards[Math.floor(Math.random() * hazards.length)];
                    } else if (Math.random() < rockChance) {
                        selectedAnimal = "🪨";
                    } else {
                        const nonRock = animals.filter(a => a !== "🪨");
                        selectedAnimal = nonRock[Math.floor(Math.random() * nonRock.length)];
                    }
                    attached.innerHTML = selectedAnimal;

                    swayWrapper.appendChild(balloon);
                    swayWrapper.appendChild(rope);
                    swayWrapper.appendChild(attached);
                    balloonGroup.appendChild(swayWrapper);

                    let balloonSpeed = animalData[selectedAnimal].speed / (1 + (level - 1) * 0.05);

                    let leftPosition;
                    do {
                        leftPosition = Math.floor(Math.random() * 250);
                    } while (usedPositions.some(pos => Math.abs(pos - leftPosition) < 50));

                    usedPositions.push(leftPosition);
                    balloonGroup.style.left = leftPosition + "px";
                    balloonGroup.style.bottom = "-50px";
                    balloonGroup.style.opacity = "0";

                    // Make entire group clickable for easier tapping
                    balloonGroup.onclick = () => popBalloon(balloonGroup, selectedAnimal);

                    document.getElementById("game-container").appendChild(balloonGroup);

                    setTimeout(() => {
                        if (isPaused) {
                            balloonGroup.remove();
                            return;
                        }
                        const h = document.getElementById("game-container").clientHeight;
                        anime({
                            targets: balloonGroup,
                            opacity: [0, 1],
                            duration: 800,
                            easing: 'linear'
                        });
                        const swayAnim = anime({
                            targets: swayWrapper,
                            translateX: [`-${15 + level * 2}px`, `${15 + level * 2}px`],
                            duration: 3000,
                            direction: 'alternate',
                            loop: true,
                            easing: 'easeInOutSine',
                            delay: Math.random() * 1000
                        });
                        const anim = anime({
                            targets: balloonGroup,
                            translateY: -h,
                            duration: balloonSpeed * 1000,
                            easing: 'easeInOutSine',
                            complete: () => {
                                swayAnim.pause();
                                const fadeAnim = anime({
                                    targets: balloonGroup,
                                    opacity: 0,
                                    duration: 500,
                                    easing: 'linear',
                                    complete: () => {
                                        balloonGroup.remove();
                                        const idx = balloonAnimations.indexOf(anim);
                                        if (idx !== -1) balloonAnimations.splice(idx, 1);
                                        const idx2 = balloonAnimations.indexOf(swayAnim);
                                        if (idx2 !== -1) balloonAnimations.splice(idx2, 1);
                                        const idx3 = balloonAnimations.indexOf(fadeAnim);
                                        if (idx3 !== -1) balloonAnimations.splice(idx3, 1);
                                    }
                                });
                                balloonAnimations.push(fadeAnim);
                            }
                        });
                        balloonAnimations.push(anim, swayAnim);
                    }, 100);
                }
            }, interval);
        }

        function popBalloon(balloonGroup, attachedItem) {
            if (isPaused) return;
            let balloon = balloonGroup.querySelector(".balloon");
            // Disable further clicks once popped
            balloonGroup.onclick = null;

            anime({
                targets: balloon,
                scale: [1, 2, 0],
                duration: 200,
                easing: 'easeInOutQuad'
            });
            setTimeout(() => {
                balloon.innerHTML = "💥";
                const pop = document.getElementById('pop-sound');
                if (pop) { pop.currentTime = 0; pop.play(); }
            }, 120);

            popCount++;
            if (attachedItem === dailyChallenge.animal && !dailyChallenge.done) {
                dailyChallenge.progress++;
                if (dailyChallenge.progress >= dailyChallenge.goal) {
                    dailyChallenge.done = true;
                }
            }

            if (attachedItem === "🪨") {
                if (shield) {
                    shield = false;
                } else {
                    score -= 10;
                }
                comboCount = 0;
                comboMultiplier = 1;
                document.getElementById('combo').innerText = '';
            } else if (powerUps.includes(attachedItem)) {
                applyPowerUp(attachedItem);
            } else if (hazards.includes(attachedItem)) {
                score -= 15;
                comboCount = 0;
                comboMultiplier = 1;
                document.getElementById('combo').innerText = '';
            } else {
                let pts = animalData[attachedItem].points;
                if (doublePoints) pts *= 2;
                pts = Math.floor(pts * comboMultiplier);
                score += pts;
                savedAnimals[attachedItem] = (savedAnimals[attachedItem] || 0) + 1;
                animalsLeft = Math.max(animalsLeft - 1, 0);
                registerCombo();
            }

            const scoreEl = document.getElementById("score");
            const animalsLeftEl = document.getElementById("animals-left");
            scoreEl.innerText = score;
            animalsLeftEl.innerText = animalsLeft;
            anime({ targets: [scoreEl, animalsLeftEl], scale: [1.3, 1], duration: 300, easing: 'easeOutElastic(1, .8)' });
            updateSavedAnimalsDisplay();
            checkAchievements();

                        const h = document.getElementById("game-container").clientHeight;
            balloonGroup.style.transform = "none";
            setTimeout(() => balloonGroup.remove(), 200);

            if (animalsLeft === 0) {
                endLevel();
            }
        }

        function updateSavedAnimalsDisplay() {
            let savedList = document.getElementById("saved-list");
            savedList.innerHTML = "";
            
            for (let animal in savedAnimals) {
                if (savedAnimals[animal] > 0) {
                    savedList.innerHTML += `${animal} x${savedAnimals[animal]} `;
                }
            }
            
            if (savedList.innerHTML === "") {
                savedList.innerHTML = "None yet";
            }
            updateAchievementsDisplay();
        }

        function updateAchievementsDisplay() {
            const achList = document.getElementById("achievements-list");
            if (achList) {
                let completed = Object.keys(achievements).filter(k => achievements[k]);
                achList.innerHTML = completed.length ? completed.join(", ") : "None yet";
            }
            const dcEl = document.getElementById("daily-challenge");
            if (dcEl) {
                dcEl.innerText = `${dailyChallenge.description} (${dailyChallenge.progress}/${dailyChallenge.goal})` + (dailyChallenge.done ? " ✅" : "");
            }
        }

        function saveProgress() {
            localStorage.setItem("achievements", JSON.stringify(achievements));
            localStorage.setItem("popCount", popCount);
            localStorage.setItem("dailyChallenge", JSON.stringify(dailyChallenge));
        }

        function checkAchievements() {
            if (!achievements.firstPop && popCount >= 1) achievements.firstPop = true;
            if (!achievements.pop50 && popCount >= 50) achievements.pop50 = true;
            if (!achievements.level5 && level >= 5) achievements.level5 = true;
            if (!achievements.combo3 && comboMultiplier >= 2) achievements.combo3 = true;
            saveProgress();
            updateAchievementsDisplay();
        }

        function applyPowerUp(type) {
            if (type === "✨") {
                doublePoints = true;
                setTimeout(() => doublePoints = false, 10000);
            } else if (type === "🧊") {
                pauseGame();
                setTimeout(() => resumeGame(), 3000);
            } else if (type === "🛡️") {
                shield = true;
                setTimeout(() => shield = false, 15000);
            }
        }

        function registerCombo() {
            comboCount++;
            comboMultiplier = 1 + Math.floor(comboCount / 3) * 0.5;
            showComboMessage();
            clearTimeout(comboTimer);
            comboTimer = setTimeout(() => {
                comboCount = 0;
                comboMultiplier = 1;
                document.getElementById("combo").innerText = "";
            }, 1000);
            if (comboMultiplier >= 2) checkAchievements();
        }

        function showComboMessage() {
            if (comboCount < 3) return;
            const msg = comboCount >= 6 ? "Amazing!" : "Great!";
            const el = document.getElementById("combo");
            el.innerText = msg + ` x${comboMultiplier.toFixed(1)}`;
        }

       function endLevel() {
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            document.getElementById("next-level").style.display = "none";
            setCookie("level", level, 7);
            setCookie("score", score, 7);
            const overlay = document.getElementById("level-complete-overlay");
            const countdownEl = document.getElementById("countdown");
            overlay.style.display = "flex";
            anime({
                targets: overlay,
                opacity: [0, 1],
                scale: [0.8, 1],
                duration: 500,
                easing: 'easeOutExpo'
            });
            let count = 3;
            countdownEl.innerText = count;
            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.innerText = count;
                    anime({ targets: countdownEl, scale: [1.4, 1], duration: 300, easing: 'easeOutBack' });
                } else {
                    clearInterval(countdownInterval);
                    anime({
                        targets: overlay,
                        opacity: [1, 0],
                        scale: [1, 1.2],
                        duration: 500,
                        easing: 'easeInExpo',
                        complete: () => {
                            overlay.style.display = 'none';
                            nextLevel();
                        }
                    });
                }
            }, 1000);
        }

       function nextLevel() {
           level++;
           setCookie("level", level, 7);
           setCookie("score", score, 7);
            checkAchievements();
            startGame();
       }

        function togglePause() {
            if (isPaused) {
                resumeGame();
            } else {
                pauseGame();
            }
        }

        function pauseGame() {
            if (isPaused) return;
            isPaused = true;
            clearInterval(balloonInterval);
            clearInterval(cloudInterval);
            clearInterval(countdownInterval);
            const countdownEl = document.getElementById("countdown");
            if (countdownEl && countdownEl.innerText) {
                remainingCountdown = parseInt(countdownEl.innerText);
            }
            balloonAnimations.forEach(anim => anim.pause());
            cloudAnimations.forEach(anim => anim.pause());
            document.querySelectorAll('.balloon').forEach(b => b.style.pointerEvents = 'none');
            document.querySelectorAll('.balloon-group').forEach(bg => bg.style.pointerEvents = 'none');
            const container = document.getElementById("game-container");
            if (container) container.classList.add("paused");
            const btn = document.getElementById("pause-btn");
            if (btn) btn.innerText = "Resume";
        }

        function resumeGame() {
            if (!isPaused) return;
            isPaused = false;
            balloonAnimations.forEach(anim => anim.play());
            cloudAnimations.forEach(anim => anim.play());
            document.querySelectorAll('.balloon').forEach(b => b.style.pointerEvents = 'auto');
            document.querySelectorAll('.balloon-group').forEach(bg => bg.style.pointerEvents = 'auto');
            const container = document.getElementById("game-container");
            if (container) container.classList.remove("paused");
            spawnClouds();
            spawnBalloons();
            if (remainingCountdown !== null) {
                let count = remainingCountdown;
                const countdownEl = document.getElementById("countdown");
                if (countdownEl) {
                    countdownEl.innerText = count;
                    countdownInterval = setInterval(() => {
                        count--;
                        if (count > 0) {
                            countdownEl.innerText = count;
                            anime({ targets: countdownEl, scale: [1.4, 1], duration: 300, easing: 'easeOutBack' });
                        } else {
                            clearInterval(countdownInterval);
                            const overlay = document.getElementById("level-complete-overlay");
                            if (overlay) {
                                anime({
                                    targets: overlay,
                                    opacity: [1, 0],
                                    scale: [1, 1.2],
                                    duration: 500,
                                    easing: 'easeInExpo',
                                    complete: () => {
                                        overlay.style.display = 'none';
                                        nextLevel();
                                    }
                                });
                            }
                        }
                    }, 1000);
                }
                remainingCountdown = null;
            }
            const btn = document.getElementById("pause-btn");
            if (btn) btn.innerText = "Pause";
        }

        startGame();
    </script>

</body>
</html>